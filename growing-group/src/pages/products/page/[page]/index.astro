---
import MainLayout from "../../../../layouts/MainLayout.astro";
import ProductGrid from "../../../../components/product/ProductGrid.astro";

async function gql(query, variables = {}) {
    const GRAPHQL_URL = "https://api.escuelajs.co/graphql";

    const res = await fetch(GRAPHQL_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, variables }),
    });

    const json = await res.json();
    if (json.errors) throw new Error(json.errors[0].message);
    return json.data;
}

const page = Number(Astro.params.page) || 1;
const PER_PAGE = 12;
const offset = (page - 1) * PER_PAGE;

// Fetch total count
const totalData = await gql(`query { products { id } }`);
const total = totalData.products.length;
const totalPages = Math.ceil(total / PER_PAGE);

// Fetch products for current page
const productsData = await gql(
    `
    query ($offset: Int!, $limit: Int!) {
        products(offset: $offset, limit: $limit) {
            id
            title
            price
            images
            description
        }
    }
    `,
    { offset, limit: PER_PAGE }
);

const products = productsData.products;

console.log(`üé® SSR: Rendering page ${page} with ${products.length} products`);

// Generate page numbers for pagination
const pageNumbers = [];
for (let i = 1; i <= totalPages; i++) {
    const showPage = i === 1 ||
        i === totalPages ||
        Math.abs(i - page) <= 1;

    if (showPage) {
        pageNumbers.push({ num: i, show: true });
    } else if (i === 2 && page > 3) {
        pageNumbers.push({ num: i, show: false, dots: true });
    } else if (i === totalPages - 1 && page < totalPages - 2) {
        pageNumbers.push({ num: i, show: false, dots: true });
    }
}
---

<MainLayout>
    <main class="container mx-auto px-6 py-12">

        <h1 class="text-5xl font-bold text-center mb-8 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
            –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤
        </h1>

        <p class="text-center text-gray-600 mb-12">
            –ü–æ–∫–∞–∑–∞–Ω–æ {products.length} —Ç–æ–≤–∞—Ä—ñ–≤ –∑ {total} (–°—Ç–æ—Ä—ñ–Ω–∫–∞ {page} –∑ {totalPages})
        </p>

        <ProductGrid products={products} />

        <div class="mt-16 flex justify-center items-center gap-3">
            {page > 1 && (
                    <a
                            href={`/products/page/${page - 1}`}
                            class="px-5 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                    >
                        ‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—è
                    </a>
            )}

            <div class="flex gap-2">
                {pageNumbers.map((item) => (
                    item.dots ? (
                            <span class="px-3 py-2 text-gray-400">...</span>
                    ) : item.show ? (
                            <a
                                    href={`/products/page/${item.num}`}
                                    class={item.num === page
                                        ? "px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold"
                                        : "px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                                    }
                            >
                                {item.num}
                            </a>
                    ) : null
                ))}
            </div>

            {page < totalPages && (
                    <a
                            href={`/products/page/${page + 1}`}
                            class="px-5 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                    >
                        –ù–∞—Å—Ç—É–ø–Ω–∞  ‚Üí
                    </a>
            )}
        </div>

    </main>
</MainLayout>